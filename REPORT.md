# CCF 2025 HIP编程竞赛项目报告

## 项目概述

本项目实现了CCF 2025 HIP编程竞赛的三个GPU加速算法挑战：**前缀和**、**Softmax**和**全对最短路径(APSP)**。所有算法均基于HIP/ROCm实现，针对AMD GPU架构优化，采用单GPU执行策略。项目在算法实现、性能优化、输出加速等方面取得了显著成果。

## 算法实现

### 1. 前缀和 (Prefix Sum)
**算法特点**：
- 实现分块扫描三阶段算法：块内扫描 → 块和扫描 → 偏移累加
- 支持Hillis-Steele和Blelloch两种扫描实现，可编译时切换
- 使用共享内存优化块内计算，支持非2次幂长度数组

**关键优化**：
- `BLOCK_SIZE=256`，适配AMD GPU架构
- 递归扫描处理大规模数据，层数为O(log_B N)
- 高性能输出：32MB缓冲区+`std::to_chars`，显著减少I/O开销

### 2. Softmax
**算法特点**：
- 实现数值稳定的softmax：`y_i = exp(x_i - max) / sum(exp(x_j - max))`
- 两阶段归约：先求全局最大值，再计算指数和并归一化
- 严格遵循数值稳定性要求，避免溢出/下溢

**关键优化**：
- 4个专用GPU内核：分块最大值、全局最大值归约、指数和计算、归一化
- 分母保护：`S + 1e-12`确保满足容差要求
- FAST_OUTPUT优化：输出性能提升3-6倍，特别适用于大规模数据

### 3. 全对最短路径 (APSP)
**算法特点**：
- 基于分块Floyd-Warshall算法，三阶段执行：
  - Phase 1: 处理pivot块(k,k)
  - Phase 2: 更新第k行/列块
  - Phase 3: 更新其余所有块
- 使用共享内存进行块内tile复用，减少全局内存访问

**关键优化**：
- **内存优化**：页锁定内存+异步传输，H2D传输提升35倍(355ms→9ms)
- **GPU计算优化**：HIP事件精确同步替代设备同步，性能提升19-26%
- **编译优化**：现代编译标志(`--offload-arch`)、循环展开、分支预测
- **输出优化**：32MB缓冲区，输出速度从100MB/s提升至540MB/s

## 技术亮点

### 1. 渐进式性能优化策略
以APSP为例，采用系统性的优化方法：
- **阶段1**：页锁定内存优化，D2H性能提升82%
- **阶段2**：异步传输+流并行，H2D性能提升97%
- **阶段3**：GPU计算核心优化，整体性能提升19-26%

### 2. 统一的高效输出框架
三个项目均实现FAST_OUTPUT优化：
- 大缓冲区(32MB)减少系统调用
- `std::to_chars`替代格式化输出
- 关闭iostream/stdio同步，启用全缓冲模式
- 保持字节级输出兼容性

### 3. 工程化实践
- **错误处理**：完整的HIP API错误检查和资源管理
- **可配置性**：编译时开关控制优化策略(FAST_OUTPUT、算法选择)
- **测试验证**：完整的测试套件，自动化校验正确性
- **性能监控**：详细的分阶段计时，支持性能分析

## 性能结果

### 定量性能数据 (基于MI100/gfx908)

| 项目 | 关键优化 | 性能提升 | 代表性指标 |
|------|----------|----------|------------|
| **Prefix Sum** | Blelloch扫描+快速输出 | 显著减少I/O开销 | 支持1亿级元素 |
| **Softmax** | 数值稳定+快速输出 | 输出加速3-6倍 | 满足1e-6绝对容差 |
| **APSP** | 综合优化 | 传输加速35倍，计算优化26% | 6400×6400矩阵：传输15ms，计算344ms |

### 关键性能突破
- **数据传输**：从388ms降至15ms (APSP)
- **输出效率**：从100MB/s提升至540MB/s  
- **GPU利用率**：事件驱动同步显著提升并行度

## 技术创新

1. **混合同步策略**：HIP事件+流实现精确依赖管理，避免过度同步
2. **自适应内存管理**：页锁定内存+异步传输的最佳实践组合  
3. **编译器协同优化**：现代HIP编译标志+手工循环优化相结合
4. **跨项目复用模式**：高效输出框架在三个算法间的成功移植

## 总结

本项目成功实现了三个高性能GPU算法，通过系统性的优化策略取得了显著的性能提升。项目不仅在算法正确性上严格验证，更在工程实践中体现了现代GPU编程的最佳实践。特别是在数据传输、GPU计算、I/O输出等关键环节的优化，为GPU计算应用提供了有价值的实现参考。

项目代码结构清晰，优化策略渐进式推进，具备良好的可维护性和扩展性，适合作为HIP/ROCm GPU编程的学习和参考案例。
